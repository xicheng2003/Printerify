# Printerify生产环境Nginx配置（已优化）
# 基于你当前的配置进行改进

server {
    server_name print.morlight.top;

    # Nginx监听内部端口，为WAF让出80/443
    listen 127.0.0.1:8080;

    # ========================================
    # 通用代理设置（应用到所有代理请求）
    # ========================================
    
    # 大文件上传优化
    proxy_request_buffering off;  # 关闭请求体缓冲，即时转发
    proxy_buffering off;          # 关闭响应缓冲
    
    # 超时设置（5分钟）
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    
    # 代理头设置
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Server $server_name;
    proxy_set_header X-Forwarded-Port $server_port;

    # 允许上传的文件大小
    client_max_body_size 200M;

    # ========================================
    # 媒体文件服务（关键修复）
    # ========================================
    
    location /media/ {
        alias /home/xicheng2003/Printerify/media/;
        
        # 【新增】处理中文文件名编码
        charset utf-8;
        
        # 【新增】设置正确的MIME类型
        types {
            application/pdf pdf;
            image/jpeg jpg jpeg;
            image/png png;
            image/gif gif;
        }
        
        # 【新增】允许跨域访问（如果前端在不同域名）
        add_header Access-Control-Allow-Origin "https://print.morlight.top" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        
        # 【新增】缓存设置
        expires 7d;
        add_header Cache-Control "public";
        
        # 【重要】禁止目录列表
        autoindex off;
        
        # 【新增】安全头
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        
        # 【修复】确保文件存在时直接返回，不尝试代理
        try_files $uri =404;
    }

    # ========================================
    # 静态文件服务
    # ========================================
    
    location /static/ {
        alias /home/xicheng2003/Printerify/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        charset utf-8;
    }

    # ========================================
    # 下载文件规则（已存在，保持不变）
    # ========================================
    
    location ~* \.(rar|zip|pdf|gz|7z)$ {
        root /home/xicheng2003/public_downloads;
        add_header Content-Disposition "attachment";
    }

    # ========================================
    # Django Admin（优先级最高）
    # ========================================
    
    location /admin {
        proxy_pass http://unix:/run/gunicorn.sock;
        # 继承全局代理头设置
    }

    # ========================================
    # API请求
    # ========================================
    
    location /api/ {
        proxy_pass http://unix:/run/gunicorn.sock;
        # 继承全局代理头设置
    }

    # ========================================
    # OAuth相关路径
    # ========================================
    
    location ~ ^/(accounts|auth|social)/ {
        proxy_pass http://unix:/run/gunicorn.sock;
        # 继承全局代理头设置
    }

    # ========================================
    # Vue前端应用（通用规则，最后匹配）
    # ========================================
    
    location / {
        root /home/xicheng2003/Printerify/frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # 前端资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}

# ========================================
# 配置说明
# ========================================
#
# 关键修复点：
# 1. /media/ location 中添加了 charset utf-8 来处理中文文件名
# 2. 添加了 try_files $uri =404 确保文件不存在时返回404而不是代理
# 3. 设置了正确的MIME类型，确保浏览器正确识别文件类型
# 4. 添加了CORS头，允许跨域访问媒体文件
#
# 应用配置：
# 1. 备份当前配置
# 2. 更新配置文件
# 3. 测试配置：sudo nginx -t
# 4. 重载配置：sudo systemctl reload nginx
#
# 文件权限检查：
# sudo chown -R xicheng2003:xicheng2003 /home/xicheng2003/Printerify/media/
# sudo chmod -R 755 /home/xicheng2003/Printerify/media/
